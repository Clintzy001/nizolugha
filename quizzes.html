<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz | Nizo Lugha</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-black: #121212;
            --card-bg: #1e1e1e;
            --accent-orange: #ff7d21;
            --accent-green: #4CAF50;
            --accent-red: #ff4444;
            --muted-text: #b3b3b3;
            --cowrie-gold: #FFD700;
        }

        body { background-color: var(--bg-black); color: white; font-family: 'Open Sans', sans-serif; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 414px; padding: 20px; height: 100vh; display: flex; flex-direction: column; }
        header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .top-bar { display: flex; align-items: center; justify-content: space-between; gap: 15px; }
        .stats-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .heart-container { color: var(--accent-red); font-size: 1.2rem; display: flex; gap: 5px; }
        .streak-container { color: var(--accent-orange); font-weight: bold; display: flex; align-items: center; gap: 8px; opacity: 0; transition: 0.3s; }
        .streak-active { opacity: 1; }
        .fa-fire.ignite { animation: flicker 0.5s infinite alternate; text-shadow: 0 0 10px var(--accent-orange); }
        .close-btn { color: white; text-decoration: none; font-size: 1.5rem; }
        .progress-track { flex-grow: 1; height: 12px; background: #333; border-radius: 10px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent-orange); transition: width 0.4s ease; }
        .quiz-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .question-text { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; margin-bottom: 30px; line-height: 1.3; }
        .options-grid { display: grid; gap: 12px; }
        .option-btn { background: var(--card-bg); border: 2px solid #333; border-radius: 15px; padding: 18px; color: white; font-size: 1rem; font-weight: 600; text-align: left; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .option-btn:active { transform: scale(0.98); }
        .correct { background: var(--accent-green) !important; border-color: var(--accent-green) !important; }
        .incorrect { background: var(--accent-red) !important; border-color: var(--accent-red) !important; animation: shake 0.3s; }
        
        #results-screen { display: none; text-align: center; flex-direction: column; justify-content: center; align-items: center; height: 100%; }
        .reward-badges { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-circle { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--accent-orange); display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Montserrat', sans-serif; }
        .stat-circle.cowrie { border-color: var(--cowrie-gold); }
        
        /* Level Up Toast */
        #level-up-toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background: var(--accent-orange); color: black; padding: 15px 30px;
            border-radius: 50px; font-weight: bold; transition: bottom 0.5s; z-index: 20000;
        }

        .btn-continue { background: var(--accent-orange); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; font-size: 1rem; margin-top: 30px; cursor: pointer; width: 80%; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        @keyframes flicker { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.2); opacity: 1; } }
    </style>
</head>
<body>

    <div id="level-up-toast">NEW LEVEL UNLOCKED! ðŸŽ‰</div>

    <div class="app-container">
        <header>
            <div class="top-bar">
                <a href="index.html" class="close-btn"><i class="fas fa-times"></i></a>
                <div class="progress-track">
                    <div id="progress-fill"></div>
                </div>
            </div>
            <div class="stats-bar">
                <div class="streak-container" id="streak-box">
                    <i class="fas fa-fire" id="streak-icon"></i> <span id="streak-count">0</span>
                </div>
                <div class="heart-container" id="heart-box">
                    <i class="fas fa-heart"></i>
                    <i class="fas fa-heart"></i>
                    <i class="fas fa-heart"></i>
                </div>
            </div>
        </header>

        <div id="quiz-screen" class="quiz-body">
            <p class="question-text" id="question-label">Loading question...</p>
            <div class="options-grid" id="options-container"></div>
        </div>

        <div id="results-screen">
            <i id="result-icon" class="fas fa-trophy" style="font-size: 4rem; color: #FFD700; margin-bottom: 20px;"></i>
            <h1 id="result-title" style="font-family: 'Montserrat';">Lesson Complete!</h1>
            
            <div class="reward-badges">
                <div class="stat-circle">
                    <span style="font-size: 1.3rem;" id="final-xp">+0</span>
                    <span style="font-size: 0.7rem; color: var(--muted-text);">XP</span>
                </div>
                <div class="stat-circle cowrie" id="cowrie-badge" style="display:none;">
                    <span style="font-size: 1.3rem; color: var(--cowrie-gold);">+5</span>
                    <span style="font-size: 0.7rem; color: var(--muted-text);">COWRIES</span>
                </div>
            </div>
            
            <button class="btn-continue" onclick="window.location.href='index.html'">CONTINUE</button>
        </div>
    </div>

    <script>
        const fallbackQuizzes = [
            { id: 1, question: "How do you say 'Hello' in Yoruba?", options: ["BÃ¡wo", "PÃ¨láº¹Ì o", "áº¸ kÃº Ã Ã¡rá»Ì€", "O dÃ  bá»Ì€"], correct: 1 },
            { id: 2, question: "What is the Swahili word for 'Teacher'?", options: ["Mwanafunzi", "Shule", "Mwalimu", "Kitabu"], correct: 2 },
            { id: 3, question: "In Igbo, what does 'Nná»á»' mean?", options: ["Goodbye", "Welcome", "Thank you", "Sorry"], correct: 1 },
            { id: 4, question: "Which of these means 'Water' in Hausa?", options: ["Abinci", "Gida", "Ruwa", "Zaki"], correct: 2 },
            { id: 5, question: "Yoruba: 'áº¸ kÃº Ã Ã¡rá»Ì€' means?", options: ["Good afternoon", "Good night", "Good morning", "Goodbye"], correct: 2 },
            { id: 6, question: "Swahili: 'Asante sana' means?", options: ["Excuse me", "Thank you very much", "I am sorry", "How are you"], correct: 1 },
            { id: 7, question: "Igbo: 'Bia' means?", options: ["Go", "Eat", "Come", "Sit"], correct: 2 },
            { id: 8, question: "Yoruba: 'Omi' means?", options: ["Food", "House", "Water", "Fire"], correct: 2 },
            { id: 9, question: "How do you say 'One' in Swahili?", options: ["Mbili", "Tatu", "Moja", "Nne"], correct: 2 },
            { id: 10, question: "Igbo: What is 'Kedu'?", options: ["Where?", "How are you?", "Who?", "What?"], correct: 1 },
            { id: 11, question: "Hausa: 'Sannu' is a common...?", options: ["Food", "Greeting", "Clothing", "Animal"], correct: 1 },
            { id: 12, question: "Swahili: 'Safari' literally means?", options: ["Lion", "Journey", "Wilderness", "Wait"], correct: 1 },
            { id: 13, question: "Yoruba: 'ÃŒyÃ¡' means?", options: ["Father", "Child", "Mother", "Friend"], correct: 2 },
            { id: 14, question: "Igbo: 'Anu' means?", options: ["Fish", "Bread", "Meat", "Rice"], correct: 2 },
            { id: 15, question: "Swahili: 'Jambo' is used to say...?", options: ["Goodbye", "Please", "Hello", "Yes"], correct: 2 },
            { id: 16, question: "Yoruba: 'BÃ¡bÃ¡' means?", options: ["Brother", "Father", "King", "Teacher"], correct: 1 },
            { id: 17, question: "Igbo: 'Ututu oma' means?", options: ["Good evening", "Good morning", "Sweet dreams", "Well done"], correct: 1 },
            { id: 18, question: "Swahili: 'Habari?' is asking...?", options: ["What time?", "What news?", "How much?", "Where to?"], correct: 1 },
            { id: 19, question: "Yoruba: 'Ebi' means?", options: ["Happy", "Hungry", "Angry", "Thirsty"], correct: 1 },
            { id: 20, question: "Igbo: 'Mba' means?", options: ["Yes", "No", "Perhaps", "Always"], correct: 1 }
        ];

        let quizData = [];
        let currentQuestionIndex = 0;
        let lives = 3;
        let currentStreak = 0;
        let totalXpEarned = 0;

        const questionLabel = document.getElementById('question-label');
        const optionsContainer = document.getElementById('options-container');
        const progressFill = document.getElementById('progress-fill');
        const heartBox = document.getElementById('heart-box');
        const streakBox = document.getElementById('streak-box');
        const streakCount = document.getElementById('streak-count');
        const streakIcon = document.getElementById('streak-icon');

        async function initQuiz() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang') || 'nigeria_yoruba';
            const cat = urlParams.get('cat') || 'basics';
            
            try {
                const dbData = await window.getLessonContent(lang, cat, 'quiz');
                quizData = (dbData && dbData.length > 0) ? dbData : fallbackQuizzes;
            } catch(e) {
                quizData = fallbackQuizzes;
            }
            loadQuestion();
        }

        function loadQuestion() {
            if (lives <= 0) return;
            const q = quizData[currentQuestionIndex];
            questionLabel.innerText = q.question || q.prompt_text;
            optionsContainer.innerHTML = '';
            const progress = (currentQuestionIndex / quizData.length) * 100;
            progressFill.style.width = progress + '%';
            const options = q.options || q.quiz_options || [];
            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `<span>${opt}</span><i class="fas fa-chevron-right" style="font-size: 0.8rem; opacity: 0.3;"></i>`;
                btn.onclick = () => handleAnswer(index, btn, q.id);
                optionsContainer.appendChild(btn);
            });
        }

        async function handleAnswer(selectedIndex, btn, contentId) {
            const q = quizData[currentQuestionIndex];
            const correctIndex = q.correct !== undefined ? q.correct : q.correct_option_index;
            const allButtons = document.querySelectorAll('.option-btn');
            allButtons.forEach(b => b.style.pointerEvents = 'none');

            if (selectedIndex === correctIndex) {
                btn.classList.add('correct');
                
                // SHOP BOOST CHECK: If XP Double is active
                let stats = JSON.parse(localStorage.getItem('nizo_stats')) || { active_boosts: {} };
                let xpToAdd = 15;
                if (stats.active_boosts?.xp_double && Date.now() < stats.active_boosts.xp_double) {
                    xpToAdd = 30; // Double XP per question
                }
                
                totalXpEarned += xpToAdd;
                currentStreak++;
                updateStreakUI();
            } else {
                btn.classList.add('incorrect');
                allButtons[correctIndex].classList.add('correct');
                lives--;
                currentStreak = 0;
                updateLivesUI();
                updateStreakUI();
                if (lives <= 0) {
                    setTimeout(() => showResults(true), 1000);
                    return;
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < quizData.length) {
                    loadQuestion();
                } else {
                    showResults(false);
                }
            }, 1500);
        }

        async function completeLesson() {
            let stats = JSON.parse(localStorage.getItem('nizo_stats')) || { xp: 0, cowries: 0 };
            
            const oldXP = stats.xp;
            stats.xp += totalXpEarned;
            stats.cowries += 5; 
            
            // Check for Level Up (Every 500 XP)
            if (Math.floor(stats.xp / 500) > Math.floor(oldXP / 500)) {
                triggerLevelUp();
            }

            try {
                localStorage.setItem('nizo_stats', JSON.stringify(stats));
                
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    await supabase.from('profiles').update({ 
                        total_xp: stats.xp, 
                        cowries: stats.cowries 
                    }).eq('id', user.id);
                }
            } catch (err) {
                console.error("Storage/Sync error:", err);
            }
        }

        function triggerLevelUp() {
            const toast = document.getElementById('level-up-toast');
            toast.style.bottom = '30px';
            setTimeout(() => { toast.style.bottom = '-100px'; }, 4000);
        }

        function updateLivesUI() {
            const hearts = heartBox.querySelectorAll('i');
            if (hearts[lives]) {
                hearts[lives].style.opacity = '0.2';
                hearts[lives].classList.replace('fas', 'far');
            }
        }

        function updateStreakUI() {
            if (currentStreak >= 2) {
                streakBox.classList.add('streak-active');
                streakCount.innerText = currentStreak;
                if (currentStreak >= 3) streakIcon.classList.add('ignite');
            } else {
                streakBox.classList.remove('streak-active');
                streakIcon.classList.remove('ignite');
            }
        }

        async function showResults(isGameOver) {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'flex';
            
            if (isGameOver) {
                document.getElementById('result-icon').className = 'fas fa-heart-broken';
                document.getElementById('result-icon').style.color = 'var(--accent-red)';
                document.getElementById('result-title').innerText = "Out of Lives!";
                document.getElementById('final-xp').innerText = `+0`;
            } else {
                progressFill.style.width = '100%';
                
                // Visual Double XP Indicator
                let stats = JSON.parse(localStorage.getItem('nizo_stats')) || { active_boosts: {} };
                if (stats.active_boosts?.xp_double && Date.now() < stats.active_boosts.xp_double) {
                    document.getElementById('final-xp').innerHTML = `+${totalXpEarned} <small style="display:block; font-size:10px;">(2X BOOST)</small>`;
                } else {
                    document.getElementById('final-xp').innerText = `+${totalXpEarned}`;
                }

                document.getElementById('cowrie-badge').style.display = 'flex';
                await completeLesson();
            }
        }

        initQuiz();
    </script>
</body>
</html>
