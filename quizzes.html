<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz | Nizo Lugha</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-black: #121212;
            --card-bg: #1e1e1e;
            --accent-orange: #ff7d21;
            --accent-green: #4CAF50;
            --accent-red: #ff4444;
            --muted-text: #b3b3b3;
            --cowrie-gold: #FFD700;
        }

        body { background-color: var(--bg-black); color: white; font-family: 'Open Sans', sans-serif; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 414px; padding: 20px; height: 100vh; display: flex; flex-direction: column; }
        header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .top-bar { display: flex; align-items: center; justify-content: space-between; gap: 15px; }
        .stats-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .heart-container { color: var(--accent-red); font-size: 1.2rem; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        .streak-container { color: var(--accent-orange); font-weight: bold; display: flex; align-items: center; gap: 8px; opacity: 0; transition: 0.3s; }
        .streak-active { opacity: 1; }
        .fa-fire.ignite { animation: flicker 0.5s infinite alternate; text-shadow: 0 0 10px var(--accent-orange); }
        .close-btn { color: white; text-decoration: none; font-size: 1.5rem; }
        .progress-track { flex-grow: 1; height: 12px; background: #333; border-radius: 10px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent-orange); transition: width 0.4s ease; }
        .quiz-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .question-text { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; margin-bottom: 30px; line-height: 1.3; }
        .options-grid { display: grid; gap: 12px; }
        .option-btn { background: var(--card-bg); border: 2px solid #333; border-radius: 15px; padding: 18px; color: white; font-size: 1rem; font-weight: 600; text-align: left; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .option-btn:active { transform: scale(0.98); }
        .correct { background: var(--accent-green) !important; border-color: var(--accent-green) !important; }
        .incorrect { background: var(--accent-red) !important; border-color: var(--accent-red) !important; animation: shake 0.3s; }
        
        #results-screen { display: none; text-align: center; flex-direction: column; justify-content: center; align-items: center; height: 100%; }
        .reward-badges { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-circle { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--accent-orange); display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Montserrat', sans-serif; }
        .stat-circle.cowrie { border-color: var(--cowrie-gold); }
        
        #level-up-toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background: var(--accent-orange); color: black; padding: 15px 30px;
            border-radius: 50px; font-weight: bold; transition: bottom 0.5s; z-index: 20000;
        }

        .btn-continue { background: var(--accent-orange); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; font-size: 1rem; margin-top: 30px; cursor: pointer; width: 80%; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        @keyframes flicker { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.2); opacity: 1; } }
    </style>
</head>
<body>

    <div id="level-up-toast">NEW LEVEL UNLOCKED! ðŸŽ‰</div>

    <div class="app-container">
        <header>
            <div class="top-bar">
                <a href="index.html" class="close-btn"><i class="fas fa-times"></i></a>
                <div class="progress-track">
                    <div id="progress-fill"></div>
                </div>
            </div>
            <div class="stats-bar">
                <div class="streak-container" id="streak-box">
                    <i class="fas fa-fire" id="streak-icon"></i> <span id="streak-count">0</span>
                </div>
                <div class="heart-container" id="heart-box">
                    <i class="fas fa-heart"></i> <span id="life-count">6</span>
                </div>
            </div>
        </header>

        <div id="quiz-screen" class="quiz-body">
            <p class="question-text" id="question-label">Loading question...</p>
            <div class="options-grid" id="options-container"></div>
        </div>

        <div id="results-screen">
            <i id="result-icon" class="fas fa-trophy" style="font-size: 4rem; color: #FFD700; margin-bottom: 20px;"></i>
            <h1 id="result-title" style="font-family: 'Montserrat';">Lesson Complete!</h1>
            
            <div class="reward-badges">
                <div class="stat-circle">
                    <span style="font-size: 1.3rem;" id="final-xp">+0</span>
                    <span style="font-size: 0.7rem; color: var(--muted-text);">XP</span>
                </div>
                <div class="stat-circle cowrie" id="cowrie-badge" style="display:none;">
                    <span style="font-size: 1.3rem; color: var(--cowrie-gold);">+5</span>
                    <span style="font-size: 0.7rem; color: var(--muted-text);">COWRIES</span>
                </div>
            </div>
            
            <button id="main-action-btn" class="btn-continue" onclick="window.location.href='index.html'">CONTINUE</button>
        </div>
    </div>

    <script>
        // EXPANDED 100 QUESTIONS DATABASE
        const fallbackQuizzes = [
            // YORUBA (1-17)
            { id: 1, question: "How do you say 'Hello' in Yoruba?", options: ["BÃ¡wo", "PÃ¨láº¹Ì o", "áº¸ kÃº Ã Ã¡rá»Ì€", "O dÃ  bá»Ì€"], correct: 1 },
            { id: 2, question: "Yoruba: 'áº¸ kÃº Ã Ã¡rá»Ì€' means?", options: ["Good afternoon", "Good night", "Good morning", "Goodbye"], correct: 2 },
            { id: 3, question: "Yoruba: 'Omi' means?", options: ["Food", "House", "Water", "Fire"], correct: 2 },
            { id: 4, question: "Yoruba: 'ÃŒyÃ¡' means?", options: ["Father", "Child", "Mother", "Friend"], correct: 2 },
            { id: 5, question: "Yoruba: 'BÃ¡bÃ¡' means?", options: ["Brother", "Father", "King", "Teacher"], correct: 1 },
            { id: 6, question: "Yoruba: 'Ebi' means?", options: ["Happy", "Hungry", "Angry", "Thirsty"], correct: 1 },
            { id: 7, question: "How do you say 'Thank you' in Yoruba?", options: ["O dÃ  bá»Ì€", "áº¸ á¹£Ã©", "áº¸ kÃ¡Ã bá»Ì€", "Ã€bÃ­"], correct: 1 },
            { id: 8, question: "Yoruba: 'áº¸ kÃ¡Ã sÃ¡n' is a greeting for...?", options: ["Morning", "Afternoon", "Evening", "Night"], correct: 1 },
            { id: 9, question: "What is 'Food' in Yoruba?", options: ["Omi", "OÃºnjáº¹", "IlÃ©", "Aá¹£á»"], correct: 1 },
            { id: 10, question: "Yoruba: 'Báº¹Ìáº¹Ì€ ni' means?", options: ["No", "Yes", "Maybe", "Never"], correct: 1 },
            { id: 11, question: "Yoruba: 'Báº¹Ìáº¹Ì€ ká»Ì' means?", options: ["Yes", "Wait", "No", "Go"], correct: 2 },
            { id: 12, question: "Yoruba: 'Ã€Ã¡rá»Ì€' is...?", options: ["Noon", "Night", "Morning", "Sunset"], correct: 2 },
            { id: 13, question: "Yoruba: 'IlÃ©' means?", options: ["Tree", "House", "Car", "Path"], correct: 1 },
            { id: 14, question: "How do you say 'Friend' in Yoruba?", options: ["á»ŒÌ€tÃ¡", "á»ŒÌ€ráº¹Ì", "ArÃ¡", "Omá»"], correct: 1 },
            { id: 15, question: "Yoruba: 'InÃº mi dÃ¹n' means?", options: ["I am sad", "I am angry", "I am happy", "I am tired"], correct: 2 },
            { id: 16, question: "Yoruba: 'Mo fáº¹Ì jáº¹un' means?", options: ["I want to sleep", "I want to eat", "I want to go", "I want to drink"], correct: 1 },
            { id: 17, question: "Yoruba: 'EnÃ¬kan' means the number...?", options: ["Five", "One", "Ten", "Two"], correct: 1 },

            // SWAHILI (18-34)
            { id: 18, question: "What is the Swahili word for 'Teacher'?", options: ["Mwanafunzi", "Shule", "Mwalimu", "Kitabu"], correct: 2 },
            { id: 19, question: "Swahili: 'Asante sana' means?", options: ["Excuse me", "Thank you very much", "I am sorry", "How are you"], correct: 1 },
            { id: 20, question: "How do you say 'One' in Swahili?", options: ["Mbili", "Tatu", "Moja", "Nne"], correct: 2 },
            { id: 21, question: "Swahili: 'Jambo' is used to say...?", options: ["Goodbye", "Please", "Hello", "Yes"], correct: 2 },
            { id: 22, question: "Swahili: 'Habari?' is asking...?", options: ["What time?", "What news?", "How much?", "Where to?"], correct: 1 },
            { id: 23, question: "Swahili: 'Safari' literally means?", options: ["Lion", "Journey", "Wilderness", "Wait"], correct: 1 },
            { id: 24, question: "What is 'Friend' in Swahili?", options: ["Adui", "Rafiki", "Ndugu", "Baba"], correct: 1 },
            { id: 25, question: "Swahili: 'Kitabu' means?", options: ["Chair", "Pen", "Book", "Table"], correct: 2 },
            { id: 26, question: "Swahili: 'Tafadhali' means?", options: ["Sorry", "Welcome", "Please", "Thank you"], correct: 2 },
            { id: 27, question: "Swahili: 'Lala salama' means?", options: ["Good morning", "Sleep well", "Safe journey", "Eat well"], correct: 1 },
            { id: 28, question: "How do you say 'Water' in Swahili?", options: ["Chakula", "Maji", "Mvua", "Maziwa"], correct: 1 },
            { id: 29, question: "Swahili: 'Shule' means?", options: ["Market", "House", "School", "Hospital"], correct: 2 },
            { id: 30, question: "Swahili: 'Hapana' means?", options: ["Yes", "No", "Wait", "Come"], correct: 1 },
            { id: 31, question: "Swahili: 'Ndiyo' means?", options: ["No", "Yes", "Maybe", "Stop"], correct: 1 },
            { id: 32, question: "Swahili: 'Mama' means?", options: ["Father", "Sister", "Mother", "Brother"], correct: 2 },
            { id: 33, question: "Swahili: 'Simba' means?", options: ["Tiger", "Elephant", "Lion", "Giraffe"], correct: 2 },
            { id: 34, question: "Swahili: 'Kesho' means?", options: ["Today", "Yesterday", "Tomorrow", "Now"], correct: 2 },

            // IGBO (35-51)
            { id: 35, question: "In Igbo, what does 'Nná»á»' mean?", options: ["Goodbye", "Welcome", "Thank you", "Sorry"], correct: 1 },
            { id: 36, question: "Igbo: 'Bia' means?", options: ["Go", "Eat", "Come", "Sit"], correct: 2 },
            { id: 37, question: "Igbo: 'Anu' means?", options: ["Fish", "Bread", "Meat", "Rice"], correct: 2 },
            { id: 38, question: "Igbo: 'Ututu oma' means?", options: ["Good evening", "Good morning", "Sweet dreams", "Well done"], correct: 1 },
            { id: 39, question: "Igbo: 'Mba' means?", options: ["Yes", "No", "Perhaps", "Always"], correct: 1 },
            { id: 40, question: "Igbo: What is 'Kedu'?", options: ["Where?", "How are you?", "Who?", "What?"], correct: 1 },
            { id: 41, question: "What is 'God' in Igbo?", options: ["Chukwu", "Mmuo", "mmadu", "Enu"], correct: 0 },
            { id: 42, question: "Igbo: 'Mmiri' means?", options: ["Food", "Water", "Sky", "Land"], correct: 1 },
            { id: 43, question: "Igbo: 'Nri' means?", options: ["Drink", "Sleep", "Food", "Work"], correct: 2 },
            { id: 44, question: "Igbo: 'Daalu' means?", options: ["Sorry", "Please", "Thank you", "Welcome"], correct: 2 },
            { id: 45, question: "Igbo: 'Nwoke' means?", options: ["Woman", "Man", "Child", "Elder"], correct: 1 },
            { id: 46, question: "Igbo: 'Nwanyi' means?", options: ["Man", "Friend", "Woman", "Teacher"], correct: 2 },
            { id: 47, question: "Igbo: 'Onye' means?", options: ["Where", "What", "Who", "How"], correct: 2 },
            { id: 48, question: "Igbo: 'Imela' means?", options: ["Well done", "I am coming", "Thank you", "Goodbye"], correct: 2 },
            { id: 49, question: "Igbo: 'Ego' means?", options: ["Time", "Money", "Paper", "Salt"], correct: 1 },
            { id: 50, question: "Igbo: 'Jaba' means?", options: ["Go", "Come", "Sit", "Dance"], correct: 0 },
            { id: 51, question: "Igbo: 'Ulo' means?", options: ["Market", "House", "Road", "River"], correct: 1 },

            // HAUSA (52-68)
            { id: 52, question: "Which of these means 'Water' in Hausa?", options: ["Abinci", "Gida", "Ruwa", "Zaki"], correct: 2 },
            { id: 53, question: "Hausa: 'Sannu' is a common...?", options: ["Food", "Greeting", "Clothing", "Animal"], correct: 1 },
            { id: 54, question: "Hausa: 'Na gode' means?", options: ["I'm sorry", "Thank you", "Welcome", "Please"], correct: 1 },
            { id: 55, question: "Hausa: 'Gida' means?", options: ["Tree", "House", "School", "Farm"], correct: 1 },
            { id: 56, question: "Hausa: 'Abinci' means?", options: ["Water", "Drink", "Food", "Meat"], correct: 2 },
            { id: 57, question: "Hausa: 'Eh' means?", options: ["No", "Yes", "Maybe", "Stop"], correct: 1 },
            { id: 58, question: "Hausa: 'A'a' means?", options: ["Yes", "Hello", "No", "Go"], correct: 2 },
            { id: 59, question: "Hausa: 'Ina kwana?' means?", options: ["How was your day?", "Good morning", "Where are you?", "Good night"], correct: 1 },
            { id: 60, question: "Hausa: 'Lafiya' means?", options: ["Sick", "Fine/Health", "Angry", "Tired"], correct: 1 },
            { id: 61, question: "Hausa: 'Uwa' means?", options: ["Father", "Mother", "Sister", "Brother"], correct: 1 },
            { id: 62, question: "Hausa: 'Baba' means?", options: ["Brother", "Uncle", "Father", "Grandpa"], correct: 2 },
            { id: 63, question: "Hausa: 'Zaki' means?", options: ["Tiger", "Lion", "Wolf", "Horse"], correct: 1 },
            { id: 64, question: "Hausa: 'Nama' means?", options: ["Fish", "Vegetable", "Meat", "Fruit"], correct: 2 },
            { id: 65, question: "Hausa: 'Doki' means?", options: ["Cow", "Camel", "Horse", "Sheep"], correct: 2 },
            { id: 66, question: "Hausa: 'Nawa ne?' asks...?", options: ["Who is it?", "How much?", "Where is it?", "What is it?"], correct: 1 },
            { id: 67, question: "Hausa: 'Rana' means?", options: ["Moon", "Star", "Sun", "Cloud"], correct: 2 },
            { id: 68, question: "Hausa: 'Dare' means?", options: ["Day", "Night", "Morning", "Evening"], correct: 1 },

            // BEMBA (69-84)
            { id: 69, question: "Bemba: 'Muli shani' means?", options: ["Goodbye", "How are you", "Thank you", "Come here"], correct: 1 },
            { id: 70, question: "Bemba: 'Natotela' means?", options: ["Please", "I'm sorry", "Thank you", "Yes"], correct: 2 },
            { id: 71, question: "How do you say 'Water' in Bemba?", options: ["Nshima", "Amenshi", "Umuto", "Ubwalwa"], correct: 1 },
            { id: 72, question: "Bemba: 'Ee' means?", options: ["No", "Maybe", "Yes", "Wait"], correct: 2 },
            { id: 73, question: "Bemba: 'Awe' means?", options: ["Yes", "No", "Hello", "Go"], correct: 1 },
            { id: 74, question: "Bemba: 'Nshisuma' means?", options: ["It is good", "It is bad", "I am happy", "I am sad"], correct: 1 },
            { id: 75, question: "Bemba: 'Mayo' means?", options: ["Father", "Mother", "Grandmother", "Aunt"], correct: 1 },
            { id: 76, question: "Bemba: 'Tata' means?", options: ["Brother", "Father", "Son", "Friend"], correct: 1 },
            { id: 77, question: "Bemba: 'Chikulu' means?", options: ["Small", "Fast", "Big", "Slow"], correct: 2 },
            { id: 78, question: "Bemba: 'Sana' means?", options: ["Little", "Very/Much", "Never", "Always"], correct: 1 },
            { id: 79, question: "Bemba: 'Ishina' means?", options: ["Age", "Place", "Name", "Work"], correct: 2 },
            { id: 80, question: "Bemba: 'Cilya' means?", options: ["This", "That", "Here", "There"], correct: 1 },
            { id: 81, question: "Bemba: 'Kwisa' means?", options: ["What", "When", "Where", "Why"], correct: 2 },
            { id: 82, question: "Bemba: 'Inshita' means?", options: ["Money", "Road", "Time", "Song"], correct: 2 },
            { id: 83, question: "Bemba: 'Abantu' means?", options: ["Animals", "Trees", "People", "Houses"], correct: 2 },
            { id: 84, question: "Bemba: 'IciBemba' is a...?", options: ["Food", "Dance", "Language", "Tool"], correct: 2 },

            // NYANJA (85-100)
            { id: 85, question: "Nyanja: 'Muli bwanji' means?", options: ["Good night", "How are you", "Where are you", "I am fine"], correct: 1 },
            { id: 86, question: "Nyanja: 'Zikomo' means?", options: ["Please", "Sorry", "Thank you / Excuse me", "Hello"], correct: 2 },
            { id: 87, question: "Nyanja: 'Madzi' means?", options: ["Food", "Sun", "Water", "Fire"], correct: 2 },
            { id: 88, question: "Nyanja: 'Inde' means?", options: ["No", "Yes", "Wait", "Stop"], correct: 1 },
            { id: 89, question: "Nyanja: 'Ayi' means?", options: ["Yes", "Hello", "No", "Goodbye"], correct: 2 },
            { id: 90, question: "Nyanja: 'Bwino' means?", options: ["Bad", "Good/Well", "Fast", "Slow"], correct: 1 },
            { id: 91, question: "Nyanja: 'Chonde' means?", options: ["Please", "Thank you", "Sorry", "Welcome"], correct: 0 },
            { id: 92, question: "Nyanja: 'Ndithu' means?", options: ["Maybe", "Never", "Truly/Indeed", "Sometimes"], correct: 2 },
            { id: 93, question: "Nyanja: 'Kudya' means?", options: ["To drink", "To eat", "To sleep", "To walk"], correct: 1 },
            { id: 94, question: "Nyanja: 'Mwana' means?", options: ["Adult", "Elder", "Child", "Teacher"], correct: 2 },
            { id: 95, question: "Nyanja: 'Nyumba' means?", options: ["Field", "Market", "House", "Car"], correct: 2 },
            { id: 96, question: "Nyanja: 'Chakudya' means?", options: ["Water", "Drink", "Food", "Plate"], correct: 2 },
            { id: 97, question: "Nyanja: 'Mmawa' means?", options: ["Afternoon", "Night", "Morning", "Evening"], correct: 2 },
            { id: 98, question: "Nyanja: 'Usiku' means?", options: ["Day", "Night", "Morning", "Sunset"], correct: 1 },
            { id: 99, question: "Nyanja: 'Sanga' means?", options: ["Slow", "Quiet", "Fast", "Happy"], correct: 2 },
            { id: 100, question: "Nyanja: 'Nyanja' literally means...?", options: ["Mountain", "Lake/River", "Forest", "Desert"], correct: 1 }
        ];

        let quizData = [];
        let currentQuestionIndex = 0;
        let lives = 6; // Starts with 6 lives
        let currentStreak = 0;
        let totalXpEarned = 0;

        const questionLabel = document.getElementById('question-label');
        const optionsContainer = document.getElementById('options-container');
        const progressFill = document.getElementById('progress-fill');
        const lifeCount = document.getElementById('life-count');
        const streakBox = document.getElementById('streak-box');
        const streakCount = document.getElementById('streak-count');
        const streakIcon = document.getElementById('streak-icon');

        async function initQuiz() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang') || 'nigeria_yoruba';
            const cat = urlParams.get('cat') || 'basics';
            
            try {
                // Shuffle questions to keep it fresh
                quizData = fallbackQuizzes.sort(() => 0.5 - Math.random()).slice(0, 15); 
            } catch(e) {
                quizData = fallbackQuizzes.slice(0, 15);
            }
            loadQuestion();
        }

        function loadQuestion() {
            if (lives <= 0) return;
            const q = quizData[currentQuestionIndex];
            questionLabel.innerText = q.question;
            optionsContainer.innerHTML = '';
            
            const progress = (currentQuestionIndex / quizData.length) * 100;
            progressFill.style.width = progress + '%';
            
            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `<span>${opt}</span><i class="fas fa-chevron-right" style="font-size: 0.8rem; opacity: 0.3;"></i>`;
                btn.onclick = () => handleAnswer(index, btn);
                optionsContainer.appendChild(btn);
            });
        }

        async function handleAnswer(selectedIndex, btn) {
            const q = quizData[currentQuestionIndex];
            const correctIndex = q.correct;
            const allButtons = document.querySelectorAll('.option-btn');
            allButtons.forEach(b => b.style.pointerEvents = 'none');

            if (selectedIndex === correctIndex) {
                btn.classList.add('correct');
                
                let stats = JSON.parse(localStorage.getItem('nizo_stats')) || { active_boosts: {} };
                let xpToAdd = 15;
                if (stats.active_boosts?.xp_double && Date.now() < stats.active_boosts.xp_double) {
                    xpToAdd = 30;
                }
                
                totalXpEarned += xpToAdd;
                currentStreak++;
                updateStreakUI();
            } else {
                btn.classList.add('incorrect');
                allButtons[correctIndex].classList.add('correct');
                lives--;
                currentStreak = 0;
                updateLivesUI();
                updateStreakUI();
                
                if (lives <= 0) {
                    setTimeout(() => showResults(true), 1000);
                    return;
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < quizData.length) {
                    loadQuestion();
                } else {
                    showResults(false);
                }
            }, 1200);
        }

        function updateLivesUI() {
            lifeCount.innerText = lives;
            if (lives <= 2) {
                document.getElementById('heart-box').style.color = "var(--accent-red)";
            }
        }

        function updateStreakUI() {
            if (currentStreak >= 2) {
                streakBox.classList.add('streak-active');
                streakCount.innerText = currentStreak;
                if (currentStreak >= 3) streakIcon.classList.add('ignite');
            } else {
                streakBox.classList.remove('streak-active');
                streakIcon.classList.remove('ignite');
            }
        }

        async function showResults(isGameOver) {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'flex';
            
            const actionBtn = document.getElementById('main-action-btn');

            if (isGameOver) {
                document.getElementById('result-icon').className = 'fas fa-heart-broken';
                document.getElementById('result-icon').style.color = 'var(--accent-red)';
                document.getElementById('result-title').innerText = "Out of Lives!";
                document.getElementById('final-xp').innerText = `+0`;
                
                // Redirect to Shop logic
                actionBtn.innerText = "BUY LIVES IN SHOP";
                actionBtn.onclick = () => window.location.href = 'shop.html';
            } else {
                progressFill.style.width = '100%';
                document.getElementById('final-xp').innerText = `+${totalXpEarned}`;
                document.getElementById('cowrie-badge').style.display = 'flex';
                await completeLesson();
            }
        }

        async function completeLesson() {
            let stats = JSON.parse(localStorage.getItem('nizo_stats')) || { xp: 0, cowries: 0 };
            const oldXP = stats.xp;
            stats.xp += totalXpEarned;
            stats.cowries += 5; 
            
            if (Math.floor(stats.xp / 500) > Math.floor(oldXP / 500)) triggerLevelUp();

            localStorage.setItem('nizo_stats', JSON.stringify(stats));
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    await supabase.from('profiles').update({ total_xp: stats.xp, cowries: stats.cowries }).eq('id', user.id);
                }
            } catch (err) {}
        }

        function triggerLevelUp() {
            const toast = document.getElementById('level-up-toast');
            toast.style.bottom = '30px';
            setTimeout(() => { toast.style.bottom = '-100px'; }, 4000);
        }

        initQuiz();
    </script>
</body>
</html>
